# 进程和线程

## 进程的概念

进程是指一个具有一定独立功能的程序在一个__数据集合__上的一次__动态执行__的过程

进程除了有程序的源代码之外，还有这个程序运行所需要的数据，换句话说，进程包含了程序执行所需要的所有状态信息

- 代码
- 数据
- 状态寄存器：CPU状态CR0，指令指针IP
- 通用寄存器：AX，BX，CX
- 进程占用的系统资源：打开的文件，占用的内存

## 进程的特点

- 动态性
- 并发性：进程可以被独立调度并占用处理机运行
- 独立性：不同的进程相互之间不影响
- 制约性：因访问共享数据/资源或进程之间同步而产生制约

## 进程与程序之间的联系

- 进程是处于执行状态下程序的抽象
- 同一个程序的多次执行对应的是不同的进程
- 进程执行除了程序之外还需要其他的资源

## 进程控制块

进程控制块（Process Control Block，PCB）是操作系统管理控制运行进程所有信息的集合

- PCB是进程存在的唯一标志：在创建进程的时候生成PCB，在终止进程的时候回收PCB，进程的组织管理通过对PCB的组织管理来实现
- PCB中的内容：进程标识信息；处理机现场保护；进程控制信息
- 进程控制信息包括：调度和状态信息；进程间通信信息；存储管理信息；进程所用的资源；与PCB相关的进程队列
- 进程控制块的组织：链表（同一状态的进程其PCB成一链表）；索引表（同一状态的进程其PCB成一索引表）

## 进程状态

- 进程创建
  - 系统初始化
  - 用户请求创建一个进程
  - 正在运行的进程执行了创建进程的系统调用
- 进程执行
- 进程等待
  - 请求并等待系统服务，无法马上完成
  - 启动某种操作，无法马上完成
  - 需要的数据没有到达
- 进程抢占
  - 高优先级的程序就绪
  - 进程执行当前时间用完
- 进程唤醒
  - 被阻塞的进程需要的资源得到满足
  - 被阻塞的进程等待的事件达到
- 进程结束
  - 正常退出（自愿）
  - 错误退出（自愿）
  - 致命错误（强制）
  - 被其他进程kill（强制）

## 三状态进程模型

- 运行
  - 进程正在处理机上运行
- 就绪
  - 进程获得了除了处理机之外的所需资源，得到处理机即可执行
- 等待
  - 进程等待某一事件的出现而暂停运行

## 挂起进程模型

处在挂起状态的进程映像在磁盘上，目的是减少内存的使用

- 等待挂起状态（Blocked-suspend）：进程在外存，并且等待某些事件出现
- 就绪挂起状态（Ready-suspend）：进程在外存，但是只要调入内存即可运行

## 线程

### 引入线程的动机

在进程内部增加一类实体，从而使得

1. 实体之间可以并发执行
2. 实体之间可以共享相同的地址空间

### 线程的概念

线程是进程的一部分，它描述指令执行流的状态。他是进程中指令执行流的最小单元，是CPU调度的基本单位

进程负责进行资源的分配：进程由一组相关的资源构成，包括地址空间、打开的各种文件等等资源

线程负责处理机调度：线程描述在进程的资源环境中，指令流的执行状态，关于执行流的各种信息放在线程控制块（TCB）中

![process v.s. thread](./pics/process_and_thread.jpg)

- 代码、数据、打开文件（这些资源）是进程的属性
- 指令执行流（寄存器、堆栈）是线程的属性
- 线程属于进程中的内容，多个线程在一个进程中存在
- 进程 = 进程 + 共享资源

### 线程的优点

1. 一个进程可以有多个线程
2. 线程之间可以并发执行
3. 线程之间可以共享进程的资源（地址空间和文件资源）
4. 线程可以减少并发执行的时间开销和空间开销：因为线程可以共享资源，所以在切换的时候不需要保存过多的信息，可以不通过内核进行直接通信

### 线程的缺点

1. 一个线程崩溃，由于资源共享的原因，会导致属于该进程的其他线程崩溃

### 线程的三种实现方式

### 1. 用户线程：在用户空间实现

POSIX Pthreads，Mach C-threads， Solaris threads

由一组用户级的线程函数库来完成线程的管理，包括：创建、终止、同步、调度

### 2. 内核线程：在内核中实现

Windows， Linux， Solaris

进程由内核通过系统调用的方式实现的线程机制，由内核完成：创建、终止、管理

### 3. 轻量级进程：在内核中实现，支持用户线程

Solaris （LightWeight Process）



