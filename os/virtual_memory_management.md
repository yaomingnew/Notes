# 虚拟存储概念：虚拟存储概念

[TOC]

## 虚拟存储的需求背景

1. 增长迅速的存储需求：比如游戏

   - 理想中的存储器：要求容量更大、速度更快、价格更便宜的非易失性存储器

2. 操作系统对存储的抽象：

   ![memory_abstraction](./pics/virtual_address_abstract.png)

   操作系统自动建立地址空间映射关系，从而使得应用程序开发变得更加简单

## 覆盖技术（overlay）

应用程序手动把需要的指令和数据保存在内存中

- 目标：在较小的可用内存中运行较大的程序

- 实现方法：依据程序的逻辑结构，将程序划分为若干功能相对独立的模块；将不会同时执行的模块共享同一块内存区域

  - 必要部分（常用功能）的代码和数据常驻内存
  - 可选部分（不常用功能）放在其他程序模块中，只在需要用到的时候装入内存
  - 不存在调用关系的模块可以相互覆盖，共用同一块内存区域

- 一个实例：

  - 程序A一共可以被分为一下6个逻辑块，其中A会调用B、C，B调用D，C调用E、F

  ![SWAPPING1](./pics/swapping1.PNG)

  ![SWAPPING2](./pics/swapping2.PNG)

  ![SWAPPING3](./pics/swapping3.PNG)

- 缺点：

  - 增加编程困难：程序员需要自己动手划分模块
  - 增加执行时间：从外存装入覆盖模块，时间换空间

## 交换技术（swapping）

swapping与overlay的区别是，overlay是当内存太小以至于一个完整的程序都无法装载进来执行，而swapping则是在多道程序运行的过程中

- 目标：增加正在运行或需要运行的程序的内存
- 实现方法：
  - 操作系统可自动将暂时不能运行的程序放到外存
  - 换入换出的基本单位是——整个进程的地址空间
- 面临的问题：
  - 何时需要发生交换：只当内存空间不足或者有不够的可能的时候换出
  - 程序换入的时候重定位：换出之后再换入的位置与之前的不同：
    - 采用动态地址映射的方法

## 覆盖与交换的比较

### 覆盖

1. 只能发生在没有调用关系的模块之间
2. 程序员必须要给出模块之间的逻辑覆盖结构
3. 发生在运行的程序内部模块之间

### 交换

1. 以整个进程为单位
2. 不需要模块之间的逻辑覆盖结构
3. 发生在内存的进程之间

- 虚拟内存的技术就是结合了覆盖与交换的优点，它可以由操作系统自动完成运行进程的换入换出，同时，不必以整个进程为单位，可以按块换入换出

## 局部性原理

- 虚拟存储技术的目标
  - 只把程序的部分内容放到内存中来，从而运行大小比物理内存更大的程序（无需程序员的干涉）
  - 实现进程在内存与外存之间的交换，从而获得更多的空闲内存空间（只交换进程的部分内容）

## 虚拟存储概念

- 思路：将不常用的部分内存块暂存到外存
- 原理：
  - 装载程序时：只将当前指令执行所需要的部分页面或段装入内存
  - 执行程序时：当遇到指令执行时需要的指令或数据不在内存中的时候（缺页），处理器通知操作系统将相应的页面调入内存中
  - 操作系统将内存中暂时不用的页或者段保存到外存中

## 虚拟页式存储

- 总体的思路：在页式存储管理的基础之上，增加请求调页和页面置换
- 具体方法：
  - 当用户的程序需要运行的时候，只装载一部分的页面，就启动程序运行
  - 当进程在运行的时候发现所需要的指令或者数据不存在的时候，向操作系统发出缺页异常的信号
  - 操作系统在处理缺页异常的时候，将外存中相应的页面调入到内存中，使得进程能够得以继续运行

## 缺页异常

- 缺页异常的处理流程
- 在什么地方保存没有被映射的页面
  - Unix/Linux中有一个交换区（swap section）
- 虚拟存储技术保存在外存中的几种选择——并不是所有的内容都要放到交换区中
  1. 如果程序时二进制的可执行文件：则直接将虚拟存储的位置指向外存中可执行文件的位置
  2. 如果是动态加载的共享库程序段：这种情况页不需要将库文件复制到交换区中
  3. 其他的情况：数据堆栈等内容，放置到交换区中

## 虚拟页式存储管理的性能

我们用有效存储访问时间这一指标来衡量虚拟存储技术的性能（Effective memory access time EAT）

EAT = 访存时间 * （1 - p） + 缺页异常处理时间 * p ——其中p为缺页率

---

## 页面置换算法的概念

- 功能：当物理内存已经存满，且产生了缺页异常的情况，需要将内存中的页面换出，将外存中的页面换入
- 目标：
  1. 尽可能减少换入换出的次数
  2. 把未来不再访问或者短期内不会被访问的页面换出
- 特殊情况：页面锁定（frame locking）
  - 描述必须常驻内存的逻辑页面
  - 操作系统的关键部分
  - 要求响应速度的代码和数据
  - 页表中锁定标志位（lock bit）
- 页面置换算法的分类
  - 局部页面置换算法：置换页面的选择范围只在当前进程所占用的物理页面
  - 全局页面置换算法：置换页面的选择范围包括当前所有可以被换出的物理页面

## 局部页面置换算法

## 全局页面置换算法

- 思路
  - 全局置换算法为每个进程分配可变数目的物理页面

### 工作集

- 定义：一个进程当前正在使用的逻辑页面的集合，可以表示为二元函数W（t，Δ）
  - t是当前的时刻
  - Δ称为工作集窗口，即一个定长的页面访问的时间窗口
  - W（t，Δ）是当前时刻t之前的Δ时间窗口内，进程访问的物理页面的集合
- 工作集的变化
  - 进程开始执行后，逐步建立较为稳定的工作集
  - 当进程访问的内存局部性区域趋于稳定的时候，工作集大小也趋于稳定
  - 当局部性区域改变的时候，工作集大小快速扩张或者收缩过渡到下一个稳定的值

### 常驻集

